<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Session 5: Data Visualization</title>
    <meta charset="utf-8" />
    <meta name="author" content="Rony Rodrigo Maximiliano Rodriguez-Ramirez" />
    <link href="libs/panelset/panelset.css" rel="stylesheet" />
    <script src="libs/panelset/panelset.js"></script>
    <link rel="stylesheet" href="libs/remark-css/default.css" type="text/css" />
    <link rel="stylesheet" href="libs/remark-css/metropolis.css" type="text/css" />
    <link rel="stylesheet" href="libs/remark-css/metropolis-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Session 5: Data Visualization
## R for Stata Users
### Rony Rodrigo Maximiliano Rodriguez-Ramirez
### The World Bank – DIME | <a href="https://github.com/worldbank">WB Github</a> <br> 16 November 2020

---




<div>
<style type="text/css">.xaringan-extra-logo {
width: 50px;
height: 128px;
z-index: 0;
background-image: url(pics/lightbulb.png);
background-size: contain;
background-repeat: no-repeat;
position: absolute;
top:1em;right:1em;
}
</style>
<script>(function () {
  let tries = 0
  function addLogo () {
    if (typeof slideshow === 'undefined') {
      tries += 1
      if (tries < 10) {
        setTimeout(addLogo, 100)
      }
    } else {
      document.querySelectorAll('.remark-slide-content:not(.inverse):not(.hide_logo)')
        .forEach(function (slide) {
          const logo = document.createElement('div')
          logo.classList = 'xaringan-extra-logo'
          logo.href = null
          slide.appendChild(logo)
        })
    }
  }
  document.addEventListener('DOMContentLoaded', addLogo)
})()</script>
</div>

# Table of contents

1. [Introduction](#intro)

2. [Exploratory Analysis](#ea)

4. [{ggplot2}'s settings](#ggplot)

5. [Saving a plot](#saving)

6. [References and recommendations](#references)


---
class: inverse, center, middle
name: intro

# Introduction

&lt;html&gt;&lt;div style='float:left'&gt;&lt;/div&gt;&lt;hr color='#D38C28' size=1px width=1100px&gt;&lt;/html&gt;

---

# Introduction

### Goals of this session

In this session, you’ll learn how to use R to produce insightful, meaningful and (hopefully) nice-looking graphs. In particular, you’ll use a package
called `ggplot2`.

Similarly to the previous session, you can find some references at the end of this presentation that include a more comprehensive discussions on data visualization.


---

# Introduction

### Before we start

* Make sure you the packages `ggplot2` and `plotly` are installed and loaded.
* Load the whr_panel.csv data set.


```r
# Packages
library(ggplot2)
library(plotly)

# Load CSV data
# Replace with where your data is

FolderPath &lt;- file.path("YOUR/FOLDER/PATH")

whr &lt;- read.csv(file.path(FolderPath,"whr_panel.csv"),
                header = T,
                stringsAsFactors = F)
```




---

# Introduction

In our workflow there are usually two distinct uses for plots:

1. **Exploratory analysis**: Quickly visualize your data in an insightful way.
  * We’ll do this using also `{ggplot2}`, but in a more simplistic way which will allow us to quickly create some basic figures.
  
2. **Publication/Reporting**: Make pretty graphs for a presentation, a project report, or to just show your boss something other than the laziest graph you could come up with:
  * We’ll do this using `ggplot2` with more customization. The idea is to create beautiful graphs.
  * `ggplot2`’s syntax is more complicated, but it’s easier to make your graphs look good with it.


---

# Tidy Data (Yes, again)

### First, we need to remember the following: 

- Is our data in a tidy format? 

If it is not, we might need to first clean it and then plot it. It will really difficult to create good graphics when your data is not cleaned or tidy. 

&gt; {ggplot} and other R packages tend to set up their functions in a way that we need a tidy data. In a few cases, these packages will require a different data structure. 

---

# {ggplot2}

### Some advantages of `ggplot2`. 

1. Consistency with the [**Grammar of Graphics**](https://www.springer.com/gp/book/9780387245447)
  * This book is the foundation of several data viz applications: {ggplot2}, {polaris-tableau}, {vega-lite}.
2. Flexibility
3. Layering and theme customizaation (way better than Stata).
4. Community


---

# {ggplot2}'s structure

After we have load our dataset. Let's plot something basic. The structure of a basic ggplot is: 

```
ggplot(data = &lt;DATA&gt;) + 
  &lt;GEOM_FUNCTION&gt;(
     mapping = aes(&lt;MAPPINGS&gt;),
     stat = &lt;STAT&gt;, 
     position = &lt;POSITION&gt;
  ) +
  &lt;COORDINATE_FUNCTION&gt; +
  &lt;FACET_FUNCTION&gt; +
  &lt;SCALE_FUNTION&gt; + 
  &lt;THEME_FUNCTION&gt;
  
```

--

&gt; There is an ongoing debate on how we should structure our ggplot. 


---

# {ggplot2}'s decomp

.pull-left[

.center[### I will stick to Thomas Lin Pedersen's decomposition.]

]

.pull-right[

![](pics/ggplot_decom.png)

]


---

# {ggplot2}'s structure

Therefore, we have the following: 

1. `Data`: The raw data that you want to visualize

2. `Layers`: geom_ and stat_ → The geometric shapes and statistical summaries representing the data

3. `Aesthetics`: aes() → Aesthetic mappings of the geometric and statistical objects

4. `Scales` scale_ → Maps between the data and the aesthetic dimensions

5. `Coordinate system`: coord_ → Maps data into the plane of the data rectangle

6. `Facets`: facet_ → The arrangement of the data into a grid of plots

7. `Visual themes`: theme() and theme_ → The overall visual defaults of a plot


---
class: inverse, center, middle    
name: ea

# Exploratory Analysis


---

# Exploratory Analysis

### Ok, enough chit-chat about the gramar of graphics. Let's start making some plots.



```r
*ggplot(data = whr_panel) +
  geom_point(mapping = aes(x = happiness_score, y = economy_gdp_per_capita)) 
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-3-1.png" width="65%" style="display: block; margin: auto;" /&gt;

---

# Exploratory Analysis

### Ok, enough chit-chat about the gramar of graphics. Let's start making some plots.



```r
ggplot(data = whr_panel) +   
* geom_point(mapping = aes(x = happiness_score, y = economy_gdp_per_capita))
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-4-1.png" width="65%" style="display: block; margin: auto;" /&gt;

---

# Exploratory Analysis

### We can also set up our mapping in the `ggplot()` function.


```r
*ggplot(data = whr_panel, aes(x = happiness_score, y = economy_gdp_per_capita)) +
  geom_point()  
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-5-1.png" width="65%" style="display: block; margin: auto;" /&gt;


---

# Exploratory Analysis

The most common `geoms` are: 


* `geom_bar()`, `geom_col()`: bar charts.
* `geom_boxplot()`: box and whiskers plots.
* `geom_density()`: density estiamtes. 
* `geom_jitter()`: jittered points.
* `geom_line()`: line plots. 


&gt; If you want to know more about layers, you can refer to [this](https://ggplot2.tidyverse.org/reference/).


---

# Exploratory Analysis

In summary, our basic plots should have the following: 

.pull-left[


```r
*ggplot(data = whr_panel,
       aes(x = happiness_score, 
           y = economy_gdp_per_capita)) +
  geom_point()  
```

]

.pull-right[

The data we want to plot.
]

---

# Exploratory Analysis

In summary, our basic plots should have the following: 

.pull-left[


```r
ggplot(data = whr_panel, 
*      aes(x = happiness_score,
*          y = economy_gdp_per_capita)) +
  geom_point()  
```

]

.pull-right[

Columns to use for `x` and `y`
]

---

# Exploratory Analysis

In summary, our basic plots should have the following: 

.pull-left[


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
* geom_point()
```

]

.pull-right[

How the plot is going to be drawn.
]

---

# Exploratory Analysis

We can also **map** colors. 


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita,
*          color = region)) +
  geom_point()
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-9-1.png" width="50%" style="display: block; margin: auto;" /&gt;


---

# Exploratory Analysis

In `{ggplot2}`, these settings are called **aesthetics**. 

&gt; "Aesthetics of the geometric and statistical objects". 

We can set up: 

* `position`:  x, y, xmin, xmax, ymin, ymax, etc.
* `colors`: color and fill.
* `transparency`: alpha.
* `sizes`: size and width.
* `shapes`: shape and linetype.


Notice that it is important to know where we are setting our aesthetics. For example:

* `geom_point(aes(color = season))` to color points based on the variable `country`
* `geom_point(color = "grey")` to color all points in the same color.


---

# Exploratory Analysis

Let's modify our last plot.

--


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
* geom_point(color = "red")
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-10-1.png" width="50%" style="display: block; margin: auto;" /&gt;

---

# Exploratory Analysis

Let's modify our last plot.

--


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
* geom_point(aes(color = region))
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-11-1.png" width="50%" style="display: block; margin: auto;" /&gt;

--

&gt; Notice that we can either set up our aesthetics at the global level our within each layer.

---
class: inverse, center, middle    
name: ggplot

# {ggplot2}'s settings


---

# {ggplot2}'s settings

Now, let's try to modify our plots. In the following slides, we are going to: 

1. Change shapes.

1. Include more geoms.

1. Separate by regions.

1. Pipe and mutate before plotting.

1. Changing scales.

1. Modify our theme.



---

# {ggplot2}: shapes



```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
* geom_point(shape = 5)
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-12-1.png" width="65%" style="display: block; margin: auto;" /&gt;

---

# {ggplot2}: shapes

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-13-1.png" width="75%" style="display: block; margin: auto;" /&gt;


---

# {ggplot2}: shapes and colors



```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,  y = economy_gdp_per_capita,           
*          shape = happiness_score &gt; mean(happiness_score),
*          color = region)) +
  geom_point() 
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-14-1.png" width="65%" style="display: block; margin: auto;" /&gt;

---

# {ggplot2}: including more geoms




```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,  y = economy_gdp_per_capita,           
           shape = happiness_score &gt; mean(happiness_score), 
           color = region)) + 
  geom_point() +
* geom_vline(xintercept = mean_happiness_score)
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-16-1.png" width="60%" style="display: block; margin: auto;" /&gt;

---

# {ggplot2}: including more geoms


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,  y = economy_gdp_per_capita)) +
  geom_point() + 
* geom_smooth()
```

```
## `geom_smooth()` using method = 'loess' and formula 'y ~ x'
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-17-1.png" width="60%" style="display: block; margin: auto;" /&gt;

---

# {ggplot2}: including more geoms and colors


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,  y = economy_gdp_per_capita, 
           color = region)) +
  geom_point() + 
* geom_smooth(aes(group = region),
*             method = "nls", formula = y ~ a * x + b, se = FALSE,
*             method.args = list(start = list(a = 0.1, b = 0.1)))
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-18-1.png" width="55%" style="display: block; margin: auto;" /&gt;


---

# {ggplot2}: including more geoms and colors


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,  y = economy_gdp_per_capita)) +
  geom_point() + 
* geom_smooth(aes(group = region),
              method = "nls", formula = y ~ a * x + b, se = FALSE, 
              method.args = list(start = list(a = 0.1, b = 0.1))) +
  facet_wrap(~ region)
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-19-1.png" width="55%" style="display: block; margin: auto;" /&gt;

---

# {ggplot2}: Pipe and mutate before plotting

Let's imagine now, that we would like to transform a variable before plotting.


.panelset[
.panel[.panel-name[R Code]



```r
whr_panel %&gt;% 
* mutate(
*   latam = ifelse(region == "Latin America and Caribbean", TRUE, FALSE)
* ) %&gt;%
  ggplot(aes(x = happiness_score, y = economy_gdp_per_capita,
*            color = latam)) +
  geom_point()
```

]

.panel[.panel-name[Plot]


&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-21-1.png" width="55%" style="display: block; margin: auto;" /&gt;

]


]


---

# {ggplot2}: Changing scales


.panelset[
.panel[.panel-name[Linear]


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
  geom_point() 
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-22-1.png" width="50%" style="display: block; margin: auto;" /&gt;

]

.panel[.panel-name[Log]


```r
ggplot(data = whr_panel, 
       aes(x = happiness_score,           
           y = economy_gdp_per_capita)) +  
  geom_point() + 
* scale_x_log10()
```

&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-23-1.png" width="50%" style="display: block; margin: auto;" /&gt;

]

]


---

# {ggplot2}: Themes

Let's go back to our plot with the `latam` dummy.

We are going to do the following to this plot: 

1. Change our theme.
2. Add correct labels. 
3. Add some annotations.
3. Modify our legends.


---

# {ggplot2}: Labs


.panelset[
.panel[.panel-name[R Code]


```r
whr_panel %&gt;% 
  mutate(
    latam = ifelse(region == "Latin America and Caribbean", TRUE, FALSE)
  ) %&gt;% 
* filter(year == 2015) %&gt;%
  ggplot(aes(x = happiness_score, y = economy_gdp_per_capita,
             color = latam)) + 
  geom_point() +
* labs(
*   x = "Happiness Score",
*   y = "GDP per capita",
*   title = "Happiness Score vs GDP per capita, 2015"
* )
```

]

.panel[.panel-name[Plot]
&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-25-1.png" width="60%" style="display: block; margin: auto;" /&gt;
]
]


---

# {ggplot2}: Legends


.panelset[
.panel[.panel-name[R Code]


```r
whr_panel %&gt;% 
  mutate(
    latam = ifelse(region == "Latin America and Caribbean", TRUE, FALSE)
  ) %&gt;% 
  filter(year == 2015) %&gt;% 
  ggplot(aes(x = happiness_score, y = economy_gdp_per_capita,
             color = latam)) + 
  geom_point() +  
* scale_color_discrete(labels = c("No", "Yes")) +
  labs(
    x = "Happiness Score", 
    y = "GDP per capita", 
*   color = "Country in Latin America\nand the Caribbean",
    title = "Happiness Score vs GDP per capita, 2015"
  )
```

]

.panel[.panel-name[Plot]
&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-27-1.png" width="70%" style="display: block; margin: auto;" /&gt;
]
]

---

# {ggplot2}: Themes


.panelset[
.panel[.panel-name[R Code]


```r
whr_panel %&gt;% 
  mutate(
    latam = ifelse(region == "Latin America and Caribbean", TRUE, FALSE)
  ) %&gt;% 
  filter(year == 2015) %&gt;% 
  ggplot(aes(x = happiness_score, y = economy_gdp_per_capita,
             color = latam)) + 
  geom_point() +  
  scale_color_discrete(labels = c("No", "Yes")) + 
  labs(
    x = "Happiness Score", 
    y = "GDP per capita", 
    color = "Country in Latin America\nand the Caribbean",
    title = "Happiness Score vs GDP per capita, 2015"
  ) + 
* theme_minimal()
```

]

.panel[.panel-name[Plot]
&lt;img src="04-data-visualizaation_files/figure-html/unnamed-chunk-29-1.png" width="70%" style="display: block; margin: auto;" /&gt;
]
]

---

# {ggplot2}: Themes

The `theme()` function allows you to modify each aspect of your plot. Some arguments are: 


```r
theme(
    # Legend title and text labels
    #:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
    # Title font color size and face
    legend.title = element_text(color, size, face),
    # Title alignment. Number from 0 (left) to 1 (right)
    legend.title.align = NULL,             
    # Text label font color size and face
    legend.text = element_text(color, size, face), 
    # Text label alignment. Number from 0 (left) to 1 (right)
    legend.text.align = NULL,
)
```

More about these modification can be found [here](https://ggplot2.tidyverse.org/reference/theme.html)

---
class: inverse, center, middle    
name: saving

# Saving a plot

---

# Saving a plot

Let's save the last plot. We will use the `ggsave()` function. 

You can either include the function after your plot or, first, save the ggplot as an object and then save the plot.





```r
ggsave(fig, 
       filename = file.path(rawOutput, "fig.png"), 
       dpi = 750, scale = 0.8,
       height = 8, width = 12)
```

--

If we want to save it as a pdf, we can include the argument `device = cairo_pdf`.



```r
# Save Plot
ggsave(fig, 
       filename = file.path(rawOutput, "fig.pdf"), 
       device = cairo_pdf, scale = 0.8,
       height = 8, width = 12)
```


---
class: inverse, center, middle    
name: references

# References and recommendations

---

# References and recommendations

* **Websites**:
  * Interactive stuff : http://www.htmlwidgets.org/
  * The R Graph Gallery: https://www.r-graph-gallery.com/
  * Gpplot official site: http://ggplot2.tidyverse.org/

* **Online courses**:
  * Johns Hopkins Exploratory Data Analysis at Coursera:
https://www.coursera.org/learn/exploratory-data-analysis

* **Books**:
  * The grammar of graphics by Leland Wilkinson.
  * Beautiful Evidence by Edward Tufte.
  * R Graphics cook book by Winston Chang
  * R for Data Science by Hadley Wickham andGarrett Grolemund


---
class: inverse, center, middle

# Thank you~
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"ratio": "16:9",
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
